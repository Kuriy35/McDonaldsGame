<UserControl x:Class="McDonalds.Views.KitchenView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:McDonalds.Views"
             xmlns:converters="clr-namespace:McDonalds.Converters"
             xmlns:vm="clr-namespace:McDonalds.ViewModels"
             d:DataContext="{d:DesignInstance Type=vm:KitchenViewModel}"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">

    <UserControl.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter" />
        <converters:EnumToColorConverter x:Key="EnumToColorConverter" />
        <converters:ProgressToColorConverter x:Key="ProgressToColorConverter" />
        <converters:IntToStringConverter x:Key="IntToStringConverter" />
    </UserControl.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="450" />
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border Grid.Column="1" Grid.Row="1" Grid.RowSpan="2" Style="{StaticResource KitchenViewResourcesBorderStyle}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0"
           Style="{StaticResource KitchenViewSectionHeaderStyle}"
           Text="Склад"/>

                <DataGrid Grid.Row="1"
          Style="{StaticResource KitchenViewResourcesDataGridStyle}"
          ItemsSource="{Binding Resources}"
          AutoGenerateColumns="False"
          CanUserAddRows="False"
          CanUserDeleteRows="False"
          HorizontalScrollBarVisibility="Disabled"
          VerticalScrollBarVisibility="Auto">

                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Назва"
                            Binding="{Binding DisplayName}"
                            Width="*"
                            MinWidth="80"
                            IsReadOnly="True"
                            ElementStyle="{StaticResource KitchenViewResourceNameStyle}"
                            HeaderStyle="{StaticResource KitchenViewDataGridHeaderStyle}"/>

                        <DataGridTextColumn Header="Запас"
                            Binding="{Binding Quantity}"
                            Width="55"
                            IsReadOnly="True"
                            HeaderStyle="{StaticResource KitchenViewDataGridHeaderStyle}">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Margin" Value="5,2"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="Купівля"
                            Binding="{Binding BuyPrice, StringFormat='{}{0:C}'}"
                            Width="60"
                            IsReadOnly="True"
                            HeaderStyle="{StaticResource KitchenViewDataGridHeaderStyle}">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="#D32F2F"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="FontSize" Value="11"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="Продаж"
                            Binding="{Binding SellPrice, StringFormat='{}{0:C}'}"
                            Width="60"
                            IsReadOnly="True"
                            HeaderStyle="{StaticResource KitchenViewDataGridHeaderStyle}">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Foreground" Value="#2E7D32"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="FontSize" Value="11"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTemplateColumn Header="К-ть" Width="60" HeaderStyle="{StaticResource KitchenViewDataGridHeaderStyle}">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBox Text="{Binding TradeQuantity, UpdateSourceTrigger=PropertyChanged, Converter={StaticResource IntToStringConverter}}"
                             Width="50"
                             InputScope="Number"
                             FontSize="11"
                             TextAlignment="Center"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTemplateColumn Header="Дія" Width="130" HeaderStyle="{StaticResource KitchenViewDataGridHeaderStyle}">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <Button Content="Купити"
                                Command="{Binding DataContext.BuyCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"
                                Width="55"
                                Margin="2"
                                Padding="3,2"
                                Background="#4CAF50"
                                Foreground="White"
                                FontSize="10"/>
                                        <Button Content="Продати"
                                Command="{Binding DataContext.SellCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}"
                                Width="55"
                                Margin="2"
                                Padding="3,2"
                                Background="#F44336"
                                Foreground="White"
                                FontSize="10"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <Border Grid.Column="0" Grid.Row="1" Background="White">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Кухня" Style="{StaticResource KitchenViewKitchenHeaderStyle}"/>
                <ItemsControl Grid.Row="1" ItemsSource="{Binding Equipment}" Margin="10">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Border Style="{StaticResource KitchenViewEquipmentBorderStyle}"
                                        BorderBrush="{Binding HasReadyProduct, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter='#55FF55|#DDDDDD'}">
                                    <Grid>
                                        <Button Command="{Binding ShowMenuCommand}"
                                                CommandParameter="{Binding}"
                                                IsEnabled="{Binding IsAvailable}"
                                                Visibility="{Binding HasReadyProduct, Converter={StaticResource InverseBooleanConverter}, ConverterParameter=Collapsed}">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <TextBlock Grid.Row="0" Text="{Binding Name}" Style="{StaticResource KitchenViewEquipmentNameStyle}"/>
                                                <Border Grid.Row="1" Style="{StaticResource KitchenViewEquipmentIconBorderStyle}">
                                                    <Image Source="{Binding IconPath}" Stretch="Uniform"/>
                                                </Border>
                                                <ProgressBar Grid.Row="2" Value="{Binding ProcessingProgress}" 
                                                             Maximum="1" Style="{StaticResource KitchenViewEquipmentProgressStyle}"
                                                             Visibility="{Binding IsBusy, Converter={StaticResource ProgressToColorConverter}}"/>
                                            </Grid>
                                        </Button>
                                    </Grid>
                                </Border>
                                <Button Command="{Binding DataContext.TakeProductCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                        CommandParameter="{Binding}"
                                        Visibility="{Binding HasReadyProduct, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Style="{StaticResource KitchenViewTakeProductButtonStyle}">
                                    <StackPanel>
                                        <TextBlock Text="{Binding Name}" Style="{StaticResource KitchenViewEquipmentNameStyle}"/>
                                        <TextBlock Text="Готово!" Style="{StaticResource KitchenViewReadyTextStyle}"/>
                                        <Border Style="{StaticResource KitchenViewEquipmentIconBorderStyle}">
                                            <Image Source="{Binding IconPath}" Stretch="Uniform"/>
                                        </Border>
                                        <TextBlock Text="Забрати продукт" Style="{StaticResource KitchenViewTakeProductTextStyle}"/>
                                    </StackPanel>
                                </Button>
                                <Popup IsOpen="{Binding MenuVisibility, Mode=TwoWay}" 
                                       PlacementTarget="{Binding RelativeSource={RelativeSource AncestorType=Grid}}" 
                                       StaysOpen="False">
                                    <Border Style="{StaticResource KitchenViewPopupBorderStyle}">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <TextBlock Grid.Row="0" Text="Вибір продукту" Style="{StaticResource KitchenViewPopupHeaderStyle}"/>
                                            <ListBox Grid.Row="1" ItemsSource="{Binding AvailableProducts}" 
                                                     SelectedItem="{Binding SelectedProductOption}" 
                                                     Style="{StaticResource KitchenViewPopupListBoxStyle}">
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Style="{StaticResource KitchenViewPopupItemGridStyle}">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Grid.Column="0" Text="{Binding Name}"/>
                                                            <TextBlock Grid.Column="1" Text=" (недоступно)" 
                                                                       Visibility="{Binding IsNotAvailable, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                                       Style="{StaticResource KitchenViewPopupNotAvailableStyle}"/>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Button Content="Приготувати" Command="{Binding SelectProductCommand}" 
                                                        Style="{StaticResource GreenButtonStyle}"/>
                                                <Button Content="Скасувати" Command="{Binding CloseMenuCommand}" 
                                                        Style="{StaticResource RedButtonStyle}"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </Popup>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </Border>

        <Border Grid.Column="0" Grid.Row="2" Style="{StaticResource KitchenViewReadyProductsBorderStyle}">
            <Grid Style="{StaticResource KitchenViewReadyProductsGridStyle}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Готові продукти" Style="{StaticResource KitchenViewSectionHeaderStyle}"/>

                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding GroupedReadyProducts}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <local:ProductSlot 
                            ProductName="{Binding Name}"
                            ProductIcon="{Binding IconPath}"
                            Quantity="{Binding Count}"
                            ProductState="{Binding State}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>

        <Border Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="0" Style="{StaticResource KitchenViewOrderQueueBorderStyle}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <TextBlock Grid.Row="0" Text="Черга замовлень" Style="{StaticResource KitchenViewOrderQueueHeaderStyle}"/>
                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                    <ItemsControl ItemsSource="{Binding OrderQueue}" Margin="10">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <StackPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource KitchenViewOrderItemBorderStyle}">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="75"/>
                                            <RowDefinition Height="*"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <Grid Grid.Row="0">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="{Binding Id, StringFormat='Замовлення - {0}'}" 
                                                       Style="{StaticResource KitchenViewOrderHeaderStyle}"/>
                                            <TextBlock Grid.Column="1" Text="{Binding TotalPrice, StringFormat='{}{0:C}'}" 
                                                       Style="{StaticResource KitchenViewOrderHeaderStyle}"/>
                                        </Grid>
                                        <ScrollViewer Grid.Row="1" Style="{StaticResource KitchenViewOrderProductsScrollStyle}">
                                            <ItemsControl ItemsSource="{Binding Products}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid Style="{StaticResource KitchenViewOrderProductItemStyle}">
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <TextBlock Grid.Column="0" Text="{Binding Name}"/>
                                                            <TextBlock Grid.Column="1" Text="{Binding State}" 
                                                                       Foreground="{Binding State, Converter={StaticResource EnumToColorConverter}}"/>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </ScrollViewer>
                                        <Button Grid.Row="2" Content="Зібрати замовлення" 
                                                Command="{Binding DataContext.AssembleOrderCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                CommandParameter="{Binding}"
                                                IsEnabled="{Binding IsCompleted, Converter={StaticResource InverseBooleanConverter}}"
                                                Style="{StaticResource KitchenViewAssembleButtonStyle}"/>
                                        <Button Grid.Row="3" Content="Видати замовлення" 
                                                Command="{Binding DataContext.ServeOrderCommand, RelativeSource={RelativeSource FindAncestor, AncestorType=local:GameView}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource KitchenViewServeButtonStyle}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>